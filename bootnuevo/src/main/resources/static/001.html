<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Insert title here</title>
<script type="text/javascript" src="jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script type="text/javascript">

	//Funciones ligadas a la pantalla
	function generarTabla(libros){
		
		$("table").empty();
		
		for(var i=0; i<libros.length; i++){
			let fila = libros[i];
			$("table").append(`<tr>
				<td>${fila.isbn}</td>
				<td>${fila.titulo}</td>
				<td>${fila.autor}</td>
				<td><input type="button" onClick="pulsarBorrar(${fila.isbn})" value="borrar elemento"/></td>
				<td><input type="button" onClick="pulsarDetalle(${fila.isbn})" value="ver elemento"/></td>
				<td><input type="button" onClick="pulsarCapitulos(${fila.isbn})" value="capitulos"/></td>
				</tr>`);
		}
	}
	
	function generarVistaDetalle(libro){
		
		$("#vistadetalle").empty();
		
		$("#vistadetalle").append(`
				<p>${libro.isbn}</p>
				<p>${libro.titulo}</p>
				<p>${libro.autor}</p>
				<p><input type="button" id="volverdetalle" value="volver"/></p>
				`)
	}
	
	function generarDetalleCapitulos(capitulos){
		
		$("#capitulos").empty();
		
		for(let i=0; i<capitulos.length;i++){
			var capitulo = capitulos[i];
			$("#capitulos").append(`
					<p>${capitulo.titulo}</p>
					<p>${capitulo.paginas}</p>
					`)
		}
	}
	
	function pulsarCapitulos(isbn){
		buscarTodosLosCapitulos(isbn).then(function(capitulos){
			$("#lista").hide();
			$("#capitulos").show();
			generarDetalleCapitulos(capitulos.data);
		})
	}
	
	function pulsarBorrar(isbn){
		borrar(isbn).then(buscarTodos).then(function(libros) {
			generarTabla(libros.data);
		});
	}
	
	function pulsarDetalle(isbn){
		buscarUno(isbn).then(function(libro){
			generarVistaDetalle(libro.data);
			$("#lista").hide();
			$("#vistadetalle").show();
		})
	}
	
	//Funciones Ajax
	function borrar(isbn){
		return axios.delete(`http://localhost:8080/webapi/libros/${isbn}`);
	}
	
	function buscarTodos(){
		return axios.get("http://localhost:8080/webapi/libros");
	}
	
	function buscarTodosLosCapitulos(isbn){
		return axios.get(`http://localhost:8080/webapi/libros/${isbn}/capitulos`);
	}
	
	function buscarUno(isbn){
		return axios.get(`http://localhost:8080/webapi/libros/${isbn}`);
	}
	
	function insertar(libro){
		return axios.post("http://localhost:8080/webapi/libros",libro);
	}
	
	$(document).ready(function(){
		
		//cuando se cargue la pagina el formulario se ocultara
		$("#formularionuevo").hide();
		
		
		//Devolvemos una variable con datos 
		let promesaAjax = buscarTodos();
		
		promesaAjax.then(function(libros){
			generarTabla(libros.data);
		})
		
		$("#botonformularionuevo").click(function(){
			$("#lista").hide();
			$("#formularionuevo").show();
		})
		
		$("body").on("click","#volverdetalle", function(){
			$("#lista").show();
			$("#vistadetalle").hide();
		})
		

		$("#salvar").click(function(){
			
			let objeto = {}
			objeto.isbn = $("#isbn").val();
			objeto.titulo = $("#titulo").val();
			objeto.autor = $("#autor").val();
			console.log(objeto);
			
			insertar(objeto).then(buscarTodos).then(function(libros){
				$("#lista").show();
				$("#formularionuevo").hide();
				generarTabla(libros.data);
			})
		})
	})
	
	
</script>
</head>
<body>

	<div id="lista">
		<table>
		</table>
		<input type="button" id="botonformularionuevo" value="Añadir">
	</div>
	
	<div id="formularionuevo">
		<form action="">
			<p>
				ISBN: <input type="text" id="isbn" name="isbn" />
			</p>
			<p>
				titulo: <input type="text" id="titulo" name="titulo" />
			</p>
			<p>
				autor: <input type="text" id="autor" name="autor" />
			</p>
			<input type="button" id="salvar" value="salvar" />
		</form>
	</div>
	
	<div id="vistadetalle">
			
	</div>
	
	<div id="capitulos">
			
	</div>
</body>
</html>